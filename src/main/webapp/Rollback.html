#ROLLBACK Script - 28 Jan

#!/bin/bash

VERSION=$ROLLBACK_VERSION
APP_NAME="Java3"
TOMCAT_HOME="/opt/tomcat"
NEXUS_URL="http://10.0.2.15:8081/repository/java3/aarush/webapp/$VERSION/webapp-$VERSION.war"

echo "### Executing Final Rollback Fix ###"

# 1. Kill everything
export BUILD_ID=dontKillMe
sh $TOMCAT_HOME/bin/shutdown.sh || true
pkill -9 -f "catalina" || true

# 2. Deep Clean
# We remove the webapp, the war, and the work cache
sudo rm -rf $TOMCAT_HOME/webapps/$APP_NAME
sudo rm -rf $TOMCAT_HOME/webapps/$APP_NAME.war
sudo rm -rf $TOMCAT_HOME/work/Catalina/localhost/$APP_NAME

# 3. Download
echo "Downloading Version $VERSION..."
curl -u admin:123 -L -f -o $TOMCAT_HOME/webapps/$APP_NAME.war "$NEXUS_URL"

# 4. Critical Permission Fix
# Sometimes the folder created by Tomcat is owned by root, causing 403.
# We set permissions BEFORE and AFTER starting.
sudo chown -R jenkins:jenkins $TOMCAT_HOME/webapps
sudo chmod -R 755 $TOMCAT_HOME/webapps

# 5. Start
sh $TOMCAT_HOME/bin/startup.sh

# 6. Wait for Extraction and Fix again
echo "Waiting for extraction..."
sleep 5
sudo chown -R jenkins:jenkins $TOMCAT_HOME/webapps/$APP_NAME || true

echo "Done. Try: http://10.0.2.15:8083/$APP_NAME/"
